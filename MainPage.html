<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Voice Effects App</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body class="bg-gray-100 min-h-screen flex flex-col items-center">
    <div class="container mx-auto p-4 sm:p-6 md:p-8 max-w-7xl w-full">
        <div class="mb-6 text-center">
            <label for="upload" class="bg-blue-500 text-white px-4 py-2 sm:px-6 sm:py-3 rounded-lg cursor-pointer hover:bg-blue-600 transition text-sm sm:text-base">
                Upload Audio File
            </label>
            <input type="file" id="upload" accept="audio/*" class="hidden">
        </div>
        
        <div id="categories">
            <h2 class="text-2xl sm:text-3xl font-bold mb-2 text-center">Pitch</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 sm:gap-4 mb-6">
                <button data-effect="Pitch-Chipmunk" class="min-w-[100px] aspect-square bg-gradient-to-br from-yellow-400 to-orange-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Chipmunk</button>
                <button data-effect="Pitch-Helium" class="min-w-[100px] aspect-square bg-gradient-to-br from-yellow-400 to-orange-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Helium</button>
                <button data-effect="Pitch-Squeaky" class="min-w-[100px] aspect-square bg-gradient-to-br from-yellow-400 to-orange-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Squeaky</button>
                <button data-effect="Pitch-High1" class="min-w-[100px] aspect-square bg-gradient-to-br from-yellow-400 to-orange-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">High1</button>
                <button data-effect="Pitch-High2" class="min-w-[100px] aspect-square bg-gradient-to-br from-yellow-400 to-orange-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">High2</button>
                <button data-effect="Pitch-NormalHigh" class="min-w-[100px] aspect-square bg-gradient-to-br from-yellow-400 to-orange-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">NormalHigh</button>
                <button data-effect="Pitch-Low1" class="min-w-[100px] aspect-square bg-gradient-to-br from-yellow-400 to-orange-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Low1</button>
                <button data-effect="Pitch-Low2" class="min-w-[100px] aspect-square bg-gradient-to-br from-yellow-400 to-orange-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Low2</button>
                <button data-effect="Pitch-Demon" class="min-w-[100px] aspect-square bg-gradient-to-br from-yellow-400 to-orange-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Demon</button>
                <button data-effect="Pitch-Deep" class="min-w-[100px] aspect-square bg-gradient-to-br from-yellow-400 to-orange-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Deep</button>
            </div>

            <h2 class="text-2xl sm:text-3xl font-bold mb-2 text-center">Reverb</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 sm:gap-4 mb-6">
                <button data-effect="Reverb-TinyRoom" class="min-w-[100px] aspect-square bg-gradient-to-br from-green-400 to-blue-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">TinyRoom</button>
                <button data-effect="Reverb-SmallRoom" class="min-w-[100px] aspect-square bg-gradient-to-br from-green-400 to-blue-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">SmallRoom</button>
                <button data-effect="Reverb-MediumRoom" class="min-w-[100px] aspect-square bg-gradient-to-br from-green-400 to-blue-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">MediumRoom</button>
                <button data-effect="Reverb-LargeRoom" class="min-w-[100px] aspect-square bg-gradient-to-br from-green-400 to-blue-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">LargeRoom</button>
                <button data-effect="Reverb-Hall" class="min-w-[100px] aspect-square bg-gradient-to-br from-green-400 to-blue-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Hall</button>
                <button data-effect="Reverb-Cathedral" class="min-w-[100px] aspect-square bg-gradient-to-br from-green-400 to-blue-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Cathedral</button>
                <button data-effect="Reverb-Plate" class="min-w-[100px] aspect-square bg-gradient-to-br from-green-400 to-blue-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Plate</button>
                <button data-effect="Reverb-Spring" class="min-w-[100px] aspect-square bg-gradient-to-br from-green-400 to-blue-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Spring</button>
            </div>

            <h2 class="text-2xl sm:text-3xl font-bold mb-2 text-center">Distortion</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 sm:gap-4 mb-6">
                <button data-effect="Distortion-Light" class="min-w-[100px] aspect-square bg-gradient-to-br from-purple-400 to-indigo-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Light</button>
                <button data-effect="Distortion-Medium" class="min-w-[100px] aspect-square bg-gradient-to-br from-purple-400 to-indigo-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Medium</button>
                <button data-effect="Distortion-Heavy" class="min-w-[100px] aspect-square bg-gradient-to-br from-purple-400 to-indigo-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Heavy</button>
                <button data-effect="Distortion-Overdrive" class="min-w-[100px] aspect-square bg-gradient-to-br from-purple-400 to-indigo-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Overdrive</button>
                <button data-effect="Distortion-Fuzz" class="min-w-[100px] aspect-square bg-gradient-to-br from-purple-400 to-indigo-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Fuzz</button>
                <button data-effect="Distortion-Crunch" class="min-w-[100px] aspect-square bg-gradient-to-br from-purple-400 to-indigo-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Crunch</button>
            </div>

            <h2 class="text-2xl sm:text-3xl font-bold mb-2 text-center">Filters</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 lg:grid-cols-5 gap-2 sm:gap-4 mb-6">
                <button data-effect="Filters-LowpassLow" class="min-w-[100px] aspect-square bg-gradient-to-br from-teal-400 to-cyan-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">LowpassLow</button>
                <button data-effect="Filters-LowpassMed" class="min-w-[100px] aspect-square bg-gradient-to-br from-teal-400 to-cyan-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">LowpassMed</button>
                <button data-effect="Filters-LowpassHigh" class="min-w-[100px] aspect-square bg-gradient-to-br from-teal-400 to-cyan-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">LowpassHigh</button>
                <button data-effect="Filters-HighpassLow" class="min-w-[100px] aspect-square bg-gradient-to-br from-teal-400 to-cyan-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">HighpassLow</button>
                <button data-effect="Filters-HighpassMed" class="min-w-[100px] aspect-square bg-gradient-to-br from-teal-400 to-cyan-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">HighpassMed</button>
                <button data-effect="Filters-HighpassHigh" class="min-w-[100px] aspect-square bg-gradient-to-br from-teal-400 to-cyan-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">HighpassHigh</button>
                <button data-effect="Filters-BandpassNarrow" class="min-w-[100px] aspect-square bg-gradient-to-br from-teal-400 to-cyan-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">BandpassNarrow</button>
                <button data-effect="Filters-BandpassWide" class="min-w-[100px] aspect-square bg-gradient-to-br from-teal-400 to-cyan-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">BandpassWide</button>
                <button data-effect="Filters-Notch" class="min-w-[100px] aspect-square bg-gradient-to-br from-teal-400 to-cyan-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Notch</button>
                <button data-effect="Filters-Peaking" class="min-w-[100px] aspect-square bg-gradient-to-br from-teal-400 to-cyan-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Peaking</button>
            </div>

            <h2 class="text-2xl sm:text-3xl font-bold mb-2 text-center">Modulation</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 sm:gap-4 mb-6">
                <button data-effect="Modulation-ChorusLight" class="min-w-[100px] aspect-square bg-gradient-to-br from-pink-400 to-red-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">ChorusLight</button>
                <button data-effect="Modulation-ChorusMed" class="min-w-[100px] aspect-square bg-gradient-to-br from-pink-400 to-red-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">ChorusMed</button>
                <button data-effect="Modulation-ChorusHeavy" class="min-w-[100px] aspect-square bg-gradient-to-br from-pink-400 to-red-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">ChorusHeavy</button>
                <button data-effect="Modulation-PhaserSlow" class="min-w-[100px] aspect-square bg-gradient-to-br from-pink-400 to-red-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">PhaserSlow</button>
                <button data-effect="Modulation-PhaserFast" class="min-w-[100px] aspect-square bg-gradient-to-br from-pink-400 to-red-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">PhaserFast</button>
                <button data-effect="Modulation-VibratoSlow" class="min-w-[100px] aspect-square bg-gradient-to-br from-pink-400 to-red-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">VibratoSlow</button>
                <button data-effect="Modulation-VibratoFast" class="min-w-[100px] aspect-square bg-gradient-to-br from-pink-400 to-red-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">VibratoFast</button>
            </div>

            <h2 class="text-2xl sm:text-3xl font-bold mb-2 text-center">Retro</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 gap-2 sm:gap-4 mb-6">
                <button data-effect="Retro-Telephone" class="min-w-[100px] aspect-square bg-gradient-to-br from-gray-400 to-black text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Telephone</button>
                <button data-effect="Retro-Radio" class="min-w-[100px] aspect-square bg-gradient-to-br from-gray-400 to-black text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Radio</button>
                <button data-effect="Retro-WalkieTalkie" class="min-w-[100px] aspect-square bg-gradient-to-br from-gray-400 to-black text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">WalkieTalkie</button>
                <button data-effect="Retro-VintageMic" class="min-w-[100px] aspect-square bg-gradient-to-br from-gray-400 to-black text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">VintageMic</button>
                <button data-effect="Retro-LoFi" class="min-w-[100px] aspect-square bg-gradient-to-br from-gray-400 to-black text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">LoFi</button>
                <button data-effect="Retro-Gramophone" class="min-w-[100px] aspect-square bg-gradient-to-br from-gray-400 to-black text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Gramophone</button>
            </div>

            <h2 class="text-2xl sm:text-3xl font-bold mb-2 text-center">Characters</h2>
            <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-2 sm:gap-4 mb-6">
                <button data-effect="Characters-Robot" class="min-w-[100px] aspect-square bg-gradient-to-br from-indigo-400 to-blue-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Robot</button>
                <button data-effect="Characters-Alien" class="min-w-[100px] aspect-square bg-gradient-to-br from-indigo-400 to-blue-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Alien</button>
                <button data-effect="Characters-Monster" class="min-w-[100px] aspect-square bg-gradient-to-br from-indigo-400 to-blue-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Monster</button>
                <button data-effect="Characters-Troll" class="min-w-[100px] aspect-square bg-gradient-to-br from-indigo-400 to-blue-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Troll</button>
                <button data-effect="Characters-Ogre" class="min-w-[100px] aspect-square bg-gradient-to-br from-indigo-400 to-blue-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Ogre</button>
                <button data-effect="Characters-DarthVader" class="min-w-[100px] aspect-square bg-gradient-to-br from-indigo-400 to-blue-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">DarthVader</button>
                <button data-effect="Characters-Devil" class="min-w-[100px] aspect-square bg-gradient-to-br from-indigo-400 to-blue-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Devil</button>
                <button data-effect="Characters-Dragon" class="min-w-[100px] aspect-square bg-gradient-to-br from-indigo-400 to-blue-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Dragon</button>
                <button data-effect="Characters-Baby" class="min-w-[100px] aspect-square bg-gradient-to-br from-indigo-400 to-blue-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Baby</button>
                <button data-effect="Characters-OldMan" class="min-w-[100px] aspect-square bg-gradient-to-br from-indigo-400 to-blue-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">OldMan</button>
                <button data-effect="Characters-Drunk" class="min-w-[100px] aspect-square bg-gradient-to-br from-indigo-400 to-blue-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Drunk</button>
                <button data-effect="Characters-Martian" class="min-w-[100px] aspect-square bg-gradient-to-br from-indigo-400 to-blue-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Martian</button>
                <button data-effect="Characters-Bee" class="min-w-[100px] aspect-square bg-gradient-to-br from-indigo-400 to-blue-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Bee</button>
                <button data-effect="Characters-Hoarse" class="min-w-[100px] aspect-square bg-gradient-to-br from-indigo-400 to-blue-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Hoarse</button>
                <button data-effect="Characters-Fan" class="min-w-[100px] aspect-square bg-gradient-to-br from-indigo-400 to-blue-500 text-white font-bold rounded-lg hover:scale-105 transition flex items-center justify-center text-sm sm:text-base">Fan</button>
            </div>
        </div>
    </div>

    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
        <div class="bg-white p-4 sm:p-6 rounded-lg shadow-lg w-full max-w-xs sm:max-w-sm md:max-w-md">
            <h3 id="effect-title" class="text-lg sm:text-xl font-bold mb-4 text-center"></h3>
            <audio id="audio-player" controls class="w-full mb-4"></audio>
            <div class="flex justify-center gap-2 sm:gap-4">
                <button id="download" class="bg-green-500 text-white px-4 py-2 rounded hover:bg-green-600 transition text-sm sm:text-base">Download</button>
                <button id="close" class="bg-red-500 text-white px-4 py-2 rounded hover:bg-red-600 transition text-sm sm:text-base">Close</button>
            </div>
        </div>
    </div>
    
    <script>
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        let originalBuffer = null;
        let uploadedFileName = 'processed';

        const uploadInput = document.getElementById('upload');
        uploadInput.addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;
            uploadedFileName = file.name.split('.')[0];
            const arrayBuf = await file.arrayBuffer();
            originalBuffer = await audioCtx.decodeAudioData(arrayBuf);
        });

        const effectButtons = document.querySelectorAll('[data-effect]');
        const modal = document.getElementById('modal');
        const effectTitle = document.getElementById('effect-title');
        const audioPlayer = document.getElementById('audio-player');
        const downloadBtn = document.getElementById('download');
        const closeBtn = document.getElementById('close');

        closeBtn.addEventListener('click', () => {
            modal.classList.add('hidden');
            audioPlayer.pause();
            audioPlayer.src = '';
        });

        effectButtons.forEach(btn => {
            btn.addEventListener('click', async () => {
                if (!originalBuffer) {
                    alert('Please upload an audio file first.');
                    return;
                }
                const effect = btn.dataset.effect;
                const processedBuffer = await applyEffect(effect, originalBuffer);
                const wavBlob = bufferToWave(processedBuffer);
                const url = URL.createObjectURL(wavBlob);
                effectTitle.textContent = effect;
                audioPlayer.src = url;
                modal.classList.remove('hidden');
                audioPlayer.play();

                downloadBtn.onclick = () => {
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `${uploadedFileName}-${effect}.wav`;
                    a.click();
                };
            });
        });

        async function applyEffect(effectName, originalBuffer) {
            const offlineCtx = new OfflineAudioContext(
                originalBuffer.numberOfChannels,
                originalBuffer.length,
                originalBuffer.sampleRate
            );
            const source = offlineCtx.createBufferSource();
            source.buffer = originalBuffer;
            let lastNode = source;

            // Helper functions
            function setPitchShift(r) {
                source.detune.value = 1200 * Math.log2(r);
            }

            function setSpeedShift(s) {
                source.playbackRate.value = s;
                source.detune.value = -1200 * Math.log2(s);
            }

            function applyEcho(delayTime, feedback) {
                const delay = offlineCtx.createDelay(delayTime * 2);
                delay.delayTime.value = delayTime;
                const gain = offlineCtx.createGain();
                gain.gain.value = feedback;
                lastNode.connect(delay);
                delay.connect(gain);
                gain.connect(lastNode);
                lastNode.connect(offlineCtx.destination);
                lastNode = delay;
            }

            function applyReverb(seconds, decay) {
                const convolver = offlineCtx.createConvolver();
                convolver.buffer = createReverbBuffer(offlineCtx, seconds, decay);
                lastNode.connect(convolver);
                lastNode = convolver;
            }

            function applyDistortion(amount) {
                const waveshaper = offlineCtx.createWaveShaper();
                waveshaper.curve = makeDistortionCurve(amount);
                waveshaper.oversample = '4x';
                lastNode.connect(waveshaper);
                lastNode = waveshaper;
            }

            function applyFilter(type, freq, q = 1) {
                const filter = offlineCtx.createBiquadFilter();
                filter.type = type;
                filter.frequency.value = freq;
                filter.Q.value = q;
                lastNode.connect(filter);
                lastNode = filter;
            }

            function applyChorus(delays) {
                // Approximate static chorus with multiple delays
                delays.forEach(d => {
                    const delay = offlineCtx.createDelay(d);
                    delay.delayTime.value = d;
                    const gain = offlineCtx.createGain();
                    gain.gain.value = 0.5;
                    lastNode.connect(delay);
                    delay.connect(gain);
                    gain.connect(offlineCtx.destination);
                });
            }

            function applyFlanger(delayTime, feedback) {
                applyEcho(delayTime, feedback);
            }

            function applyPhaser(stages) {
                for (let i = 0; i < stages; i++) {
                    const allpass = offlineCtx.createBiquadFilter();
                    allpass.type = 'allpass';
                    allpass.frequency.value = 440 * Math.pow(2, i / 12); // approximate
                    lastNode.connect(allpass);
                    lastNode = allpass;
                }
            }

            // For vibrato and tremolo, approximate with slight pitch or gain, but static, so perhaps skip or use filter
            // For now, use pitch shift or filter for approximation

            switch (effectName) {
                // Pitch
                case 'Pitch-Chipmunk':
                    setPitchShift(1.5);
                    break;
                case 'Pitch-Helium':
                    setPitchShift(1.8);
                    break;
                case 'Pitch-Squeaky':
                    setPitchShift(2.0);
                    break;
                case 'Pitch-High1':
                    setPitchShift(1.2);
                    break;
                case 'Pitch-High2':
                    setPitchShift(1.3);
                    break;
                case 'Pitch-NormalHigh':
                    setPitchShift(1.1);
                    break;
                case 'Pitch-Low1':
                    setPitchShift(0.9);
                    break;
                case 'Pitch-Low2':
                    setPitchShift(0.8);
                    break;
                case 'Pitch-Demon':
                    setPitchShift(0.7);
                    break;
                case 'Pitch-Deep':
                    setPitchShift(0.6);
                    break;



                // Reverb
                case 'Reverb-TinyRoom':
                    applyReverb(0.5, 2);
                    break;
                case 'Reverb-SmallRoom':
                    applyReverb(1, 2);
                    break;
                case 'Reverb-MediumRoom':
                    applyReverb(2, 2);
                    break;
                case 'Reverb-LargeRoom':
                    applyReverb(3, 3);
                    break;
                case 'Reverb-Hall':
                    applyReverb(4, 3);
                    break;
                case 'Reverb-Cathedral':
                    applyReverb(5, 4);
                    break;
                case 'Reverb-Plate':
                    applyReverb(2, 5);
                    break;
                case 'Reverb-Spring':
                    applyReverb(3, 4);
                    break;

                // Distortion
                case 'Distortion-Light':
                    applyDistortion(10);
                    break;
                case 'Distortion-Medium':
                    applyDistortion(30);
                    break;
                case 'Distortion-Heavy':
                    applyDistortion(50);
                    break;
                case 'Distortion-Overdrive':
                    applyDistortion(20);
                    break;
                case 'Distortion-Fuzz':
                    applyDistortion(100);
                    break;
                case 'Distortion-Crunch':
                    applyDistortion(40);
                    break;

                // Filters
                case 'Filters-LowpassLow':
                    applyFilter('lowpass', 500);
                    break;
                case 'Filters-LowpassMed':
                    applyFilter('lowpass', 1000);
                    break;
                case 'Filters-LowpassHigh':
                    applyFilter('lowpass', 2000);
                    break;
                case 'Filters-HighpassLow':
                    applyFilter('highpass', 100);
                    break;
                case 'Filters-HighpassMed':
                    applyFilter('highpass', 300);
                    break;
                case 'Filters-HighpassHigh':
                    applyFilter('highpass', 500);
                    break;
                case 'Filters-BandpassNarrow':
                    applyFilter('bandpass', 1000, 10);
                    break;
                case 'Filters-BandpassWide':
                    applyFilter('bandpass', 1000, 1);
                    break;
                case 'Filters-Notch':
                    applyFilter('notch', 1000, 10);
                    break;
                case 'Filters-Peaking':
                    applyFilter('peaking', 1000, 10);
                    break;

                // Modulation - approximations
                case 'Modulation-ChorusLight':
                    applyChorus([0.01, 0.02]);
                    break;
                case 'Modulation-ChorusMed':
                    applyChorus([0.02, 0.03, 0.04]);
                    break;
                case 'Modulation-ChorusHeavy':
                    applyChorus([0.03, 0.04, 0.05, 0.06]);
                    break;
      
                case 'Modulation-PhaserSlow':
                    applyPhaser(4);
                    break;
                case 'Modulation-PhaserFast':
                    applyPhaser(8);
                    break;
                case 'Modulation-VibratoSlow':
                    // Approximate with slight pitch shift
                    setPitchShift(1.05);
                    break;
                case 'Modulation-VibratoFast':
                    setPitchShift(1.1);
                    break;


                // Retro
                case 'Retro-Telephone':
                    applyFilter('highpass', 300);
                    applyFilter('lowpass', 3000);
                    break;
                case 'Retro-Radio':
                    applyFilter('lowpass', 2000);
                    applyDistortion(10);
                    break;
                case 'Retro-WalkieTalkie':
                    applyFilter('bandpass', 1000, 5);
                    applyDistortion(20);
                    break;
                case 'Retro-VintageMic':
                    applyFilter('highpass', 100);
                    applyFilter('lowpass', 5000);
                    applyDistortion(5);
                    break;
                case 'Retro-LoFi':
                    applyFilter('lowpass', 4000);
                    applyDistortion(15);
                    break;
                case 'Retro-Gramophone':
                    applyFilter('highpass', 200);
                    applyFilter('lowpass', 3000);
                    applyDistortion(25);
                    break;

                // Characters - combinations
                case 'Characters-Robot':
                    applyFilter('bandpass', 500, 10);
                    applyDistortion(10);
                    break;
                case 'Characters-Alien':
                    setPitchShift(1.2);
                    applyReverb(2, 3);
                    break;
                case 'Characters-Monster':
                    setPitchShift(0.8);
                    applyDistortion(30);
                    applyEcho(0.2, 0.5);
                    break;
                case 'Characters-Troll':
                    setPitchShift(0.7);
                    applyDistortion(20);
                    break;
                case 'Characters-Ogre':
                    setPitchShift(0.6);
                    applyReverb(1, 2);
                    break;
                case 'Characters-DarthVader':
                    setPitchShift(0.7);
                    applyReverb(3, 3);
                    applyDistortion(10);
                    break;
                case 'Characters-Devil':
                    setPitchShift(0.9);
                    applyDistortion(40);
                    applyReverb(2, 4);
                    break;
                case 'Characters-Dragon':
                    setPitchShift(0.5);
                    applyEcho(0.5, 0.7);
                    break;
                case 'Characters-Baby':
                    setPitchShift(1.5);
                    applyFilter('highpass', 500);
                    break;
                case 'Characters-OldMan':
                    setPitchShift(0.9);
                    applyFilter('lowpass', 3000);
                    applyDistortion(5);
                    break;
                case 'Characters-Drunk':
                    setSpeedShift(0.9);
                    applyFilter('lowpass', 2000);
                    break;
                case 'Characters-Martian':
                    setPitchShift(1.1);
                    applyPhaser(6);
                    break;
                case 'Characters-Bee':
                    setPitchShift(2.0);
                    applyFilter('highpass', 1000);
                    break;
                case 'Characters-Hoarse':
                    applyDistortion(15);
                    applyFilter('lowpass', 4000);
                    break;
                case 'Characters-Fan':
                    applyFilter('lowpass', 1000);
                    applyReverb(1, 2);
                    break;
            }

            lastNode.connect(offlineCtx.destination);
            source.start();
            return await offlineCtx.startRendering();
        }

        function createReverbBuffer(ctx, seconds, decay, reverse = false) {
            const len = ctx.sampleRate * seconds;
            const impulse = ctx.createBuffer(2, len, ctx.sampleRate);
            const left = impulse.getChannelData(0);
            const right = impulse.getChannelData(1);
            for (let i = 0; i < len; i++) {
                const val = (Math.random() * 2 - 1) * Math.pow(1 - i / len, decay);
                left[i] = val;
                right[i] = val;
            }
            if (reverse) {
                left.reverse();
                right.reverse();
            }
            return impulse;
        }

        function makeDistortionCurve(amount) {
            const k = typeof amount === 'number' ? amount : 50;
            const n_samples = 44100;
            const curve = new Float32Array(n_samples);
            const deg = Math.PI / 180;
            for (let i = 0; i < n_samples; ++i) {
                const x = i * 2 / n_samples - 1;
                curve[i] = (3 + k) * x * 20 * deg / (Math.PI + k * Math.abs(x));
            }
            return curve;
        }

        function bufferToWave(abuffer) {
            let numOfChan = abuffer.numberOfChannels,
                length = abuffer.length * numOfChan * 2 + 44,
                buffer = new ArrayBuffer(length),
                view = new DataView(buffer),
                channels = [], i, sample,
                offset = 0,
                pos = 0;

            // write WAVE header
            setUint32(0x46464952); // "RIFF"
            setUint32(length - 8); // file length - 8
            setUint32(0x45564157); // "WAVE"

            setUint32(0x20746d66); // "fmt " chunk
            setUint32(16); // length = 16
            setUint16(1); // PCM (uncompressed)
            setUint16(numOfChan);
            setUint32(abuffer.sampleRate);
            setUint32(abuffer.sampleRate * 2 * numOfChan); // avg. bytes/sec
            setUint16(numOfChan * 2); // block-align
            setUint16(16); // 16-bit

            setUint32(0x61746164); // "data" chunk
            setUint32(length - pos - 4); // chunk length

            // write interleaved data
            for (i = 0; i < abuffer.numberOfChannels; i++)
                channels.push(abuffer.getChannelData(i));

            while (pos < length) {
                for (i = 0; i < numOfChan; i++) {
                    sample = Math.max(-1, Math.min(1, channels[i][offset])); // clamp
                    sample = (0.5 + sample < 0 ? sample * 32768 : sample * 32767) | 0; // scale to 16-bit signed int
                    view.setInt16(pos, sample, true); // little endian
                    pos += 2;
                }
                offset++;
            }

            return new Blob([buffer], { type: "audio/wav" });

            function setUint16(data) {
                view.setUint16(pos, data, true);
                pos += 2;
            }

            function setUint32(data) {
                view.setUint32(pos, data, true);
                pos += 4;
            }
        }
    </script>
</body>

</html>
